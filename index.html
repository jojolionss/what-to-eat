<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- Updated Viewport for iOS: disable zoom, handle notch -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ä»Šå¤©åƒä»€ä¹ˆ">
    <meta name="format-detection" content="telephone=no">

    <!-- App Icon for Home Screen (Fried Egg Icon) -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/562/562678.png">

    <title>ä»Šå¤©åƒä»€ä¹ˆï¼Ÿå®Œç¾æ²»æ„ˆé€‰æ‹©å›°éš¾ç—‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* iOS System Font Stack */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            background-color: #fef3c7; /* Amber 50 */
            /* iOS Safe Area Support */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            /* Prevent tap highlight color */
            -webkit-tap-highlight-color: transparent;
            /* Smooth scrolling */
            -webkit-overflow-scrolling: touch;
        }

        .food-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .btn-select {
            transition: all 0.2s;
        }

        .btn-select.active {
            background-color: #f59e0b; /* Amber 500 */
            color: white;
            border-color: #f59e0b;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3);
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Confetti animation for result */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

        /* Recipe card styling */
        .recipe-card {
            background-image: radial-gradient(#fcd34d 15%, transparent 16%), radial-gradient(#fcd34d 15%, transparent 16%);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            background-color: #fffbeb;
        }

        /* Restaurant card styling */
        .restaurant-card {
            background-image: radial-gradient(#cbd5e1 15%, transparent 16%), radial-gradient(#cbd5e1 15%, transparent 16%);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-gray-800">

    <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl overflow-hidden relative border-4 border-orange-200 flex flex-col">
        
        <!-- Header -->
        <div class="bg-orange-500 p-6 text-center relative overflow-hidden flex-shrink-0">
            <!-- App Icon Preview (Added per request) -->
            <img src="https://cdn-icons-png.flaticon.com/512/562/562678.png" class="absolute top-4 left-4 w-10 h-10 rounded-xl shadow-md z-20 bg-white p-1.5" alt="App Icon">

            <div class="absolute top-0 left-0 w-full h-full opacity-10">
                <i class="fas fa-utensils text-6xl absolute -top-2 -left-2 transform rotate-12"></i>
                <i class="fas fa-hamburger text-6xl absolute top-4 right-4 transform -rotate-12"></i>
                <i class="fas fa-pizza-slice text-6xl absolute bottom-0 left-10"></i>
            </div>
            <h1 class="text-3xl font-bold text-white relative z-10 mb-1 tracking-tight">ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ</h1>
            <p class="text-orange-100 text-sm relative z-10 font-medium">æŠŠå‘½è¿ï¼ˆå’Œèƒƒå£ï¼‰äº¤ç»™éšæœºç®—æ³•</p>
        </div>

        <div class="p-6 space-y-6 flex-grow overflow-y-auto">
            
            <!-- Filters -->
            <div class="space-y-4">
                <!-- Meal Time -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æ—¶é—´ç‚¹</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setMeal('breakfast')" id="btn-breakfast" class="btn-select px-2 py-2.5 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-orange-50 w-full">
                            æ—©é¤
                        </button>
                        <button onclick="setMeal('lunch')" id="btn-lunch" class="btn-select active px-2 py-2.5 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-orange-50 w-full">
                            åˆé¤
                        </button>
                        <button onclick="setMeal('dinner')" id="btn-dinner" class="btn-select px-2 py-2.5 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-orange-50 w-full">
                            æ™šé¤
                        </button>
                        <button onclick="setMeal('midnight')" id="btn-midnight" class="btn-select px-2 py-2.5 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-orange-50 w-full">
                            å¤œå®µ
                        </button>
                    </div>
                </div>

                <!-- Dining Mode -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æ–¹å¼</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setMode('delivery')" id="btn-delivery" class="btn-select active px-2 py-3 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-orange-50 w-full">
                            <i class="fas fa-motorcycle mr-1"></i>å¤–å–
                        </button>
                        <button onclick="setMode('restaurant')" id="btn-restaurant" class="btn-select px-2 py-3 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-orange-50 w-full">
                            <i class="fas fa-store mr-1"></i>å ‚é£Ÿ
                        </button>
                        <button onclick="setMode('home')" id="btn-home" class="btn-select px-2 py-3 rounded-xl border border-gray-200 text-sm font-semibold text-gray-600 hover:bg-orange-50 w-full">
                            <i class="fas fa-utensil-spoon mr-1"></i>è‡ªå·±åš
                        </button>
                    </div>
                </div>
            </div>

            <!-- Display Area -->
            <div id="result-container" class="bg-gray-50 rounded-2xl p-8 text-center min-h-[160px] flex flex-col items-center justify-center border-2 border-dashed border-gray-300 relative transition-all duration-300">
                <div id="placeholder-icon" class="text-gray-300 mb-2">
                    <i class="fas fa-question-circle text-4xl"></i>
                </div>
                <h2 id="food-display" class="text-3xl font-bold text-gray-700 leading-tight">ç­‰å¾…é€‰æ‹©...</h2>
                <p id="food-desc" class="text-sm text-gray-400 mt-2 hidden">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹</p>

                <!-- 1. Recipe Container (For Home Mode) -->
                <div id="recipe-container" class="hidden mt-6 w-full bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-left shadow-sm relative recipe-card">
                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-100 px-3 py-0.5 rounded-full border border-yellow-200 shadow-sm">
                         <span class="text-xs font-bold text-yellow-700">ğŸ§‘â€ğŸ³ æ‡’äººé£Ÿè°±</span>
                    </div>
                    
                    <!-- Ingredients -->
                    <div class="mb-3">
                        <h3 class="text-xs font-bold text-yellow-800 uppercase tracking-wide mb-1 flex items-center">
                            <i class="fas fa-shopping-basket mr-1.5 opacity-70"></i> é‡‡è´­æ¸…å•
                        </h3>
                        <p id="recipe-ingredients" class="text-sm text-gray-700 leading-relaxed font-medium pl-1 border-l-2 border-yellow-300">
                            <!-- Ingredients will go here -->
                        </p>
                    </div>

                    <!-- Divider -->
                    <div class="border-t border-yellow-200 my-2 border-dashed"></div>

                    <!-- Steps -->
                    <div>
                        <h3 class="text-xs font-bold text-yellow-800 uppercase tracking-wide mb-1 flex items-center">
                            <i class="fas fa-fire-alt mr-1.5 opacity-70"></i> ç®€æ˜“åšæ³•
                        </h3>
                        <p id="recipe-steps" class="text-sm text-gray-600 leading-relaxed text-justify">
                            <!-- Steps will go here -->
                        </p>
                    </div>

                    <!-- Search Button -->
                    <a id="search-link" href="#" target="_blank" class="mt-4 block w-full text-center bg-white border border-yellow-300 hover:bg-yellow-100 text-yellow-700 text-xs font-bold py-3 rounded-lg transition duration-150 active:bg-yellow-200">
                        <i class="fab fa-tiktok mr-1"></i> å»æŠ–éŸ³çœ‹è§†é¢‘æ•™ç¨‹
                    </a>
                </div>

                <!-- 2. Restaurant Container (For Restaurant Mode) -->
                <div id="restaurant-container" class="hidden mt-6 w-full bg-blue-50 border border-blue-200 p-4 rounded-lg text-left shadow-sm relative restaurant-card">
                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-blue-100 px-3 py-0.5 rounded-full border border-blue-200 shadow-sm">
                         <span class="text-xs font-bold text-blue-700">ğŸ“ å‘¨è¾¹æ¢åº—</span>
                    </div>

                    <p class="text-sm text-gray-600 text-center mb-3">
                        æƒ³åƒ<span id="restaurant-food-name" class="font-bold text-blue-600 mx-1"></span>ï¼Ÿ<br>
                        çœ‹çœ‹é™„è¿‘ 10km å†…å“ªå®¶è¯„ä»·æœ€å¥½ï¼
                    </p>

                    <div class="grid grid-cols-2 gap-3">
                        <!-- Meituan: Minimalist Yellow Dot -->
                        <button onclick="searchNearby('meituan')" class="flex flex-col items-center justify-center p-3 bg-white border border-yellow-300 rounded-xl hover:bg-yellow-50 transition shadow-sm active:scale-95 group">
                            <!-- Simply a yellow circle -->
                            <div class="w-4 h-4 rounded-full bg-[#FFC300] mb-2 shadow-sm group-hover:scale-125 transition-transform"></div>
                            <span class="text-xs font-bold text-gray-700">ç¾å›¢</span>
                            <span class="text-[10px] text-gray-400">çœ‹è¯„åˆ†/å›¢è´­</span>
                        </button>

                        <!-- Amap: Minimalist Blue Dot -->
                        <button onclick="searchNearby('amap')" class="flex flex-col items-center justify-center p-3 bg-white border border-blue-200 rounded-xl hover:bg-blue-50 transition shadow-sm active:scale-95 group">
                            <!-- Simply a blue circle, no arrow -->
                            <div class="w-4 h-4 rounded-full bg-blue-500 mb-2 shadow-sm group-hover:scale-125 transition-transform"></div>
                            <span class="text-xs font-bold text-gray-700">é«˜å¾·åœ°å›¾</span>
                            <span class="text-[10px] text-gray-400">æŸ¥è·ç¦»/å¯¼èˆª</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- Action Button -->
            <button onclick="startRandomize()" id="action-btn" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-4 rounded-xl shadow-lg transform transition hover:scale-[1.02] active:scale-95 text-lg flex items-center justify-center gap-2 mb-4">
                <i class="fas fa-dice"></i> å¸®æˆ‘å†³å®šï¼
            </button>
            
        </div>
    </div>

    <!-- Confetti Container -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50 overflow-hidden hidden"></div>

    <script>
        // --- Data ---
        const foodDatabase = [
            // --- Breakfast ---
            { 
                name: "è±†æµ†æ²¹æ¡", 
                meals: ["breakfast"], 
                modes: ["delivery", "restaurant", "home"], 
                ingredients: "é€Ÿå†»æ²¹æ¡ã€è±†æµ†ç²‰ï¼ˆæˆ–ç°ç£¨è±†æµ†ï¼‰ã€ç³–",
                steps: "1. ç©ºæ°”ç‚¸é”…180åº¦çƒ¤æ²¹æ¡5åˆ†é’Ÿï¼ˆæˆ–æ²¹é”…å¤ç‚¸ï¼‰ã€‚2. å†²æ³¡çƒ­è±†æµ†ã€‚3. æ²¹æ¡è˜¸è±†æµ†ï¼Œç»é…ï¼"
            },
            { 
                name: "çš®è›‹ç˜¦è‚‰ç²¥", 
                meals: ["breakfast", "midnight"], 
                modes: ["delivery", "restaurant", "home"], 
                ingredients: "çš®è›‹ã€çŒªé‡Œè„Šè‚‰/ç˜¦è‚‰ã€å¤§ç±³ã€å§œä¸ã€è‘±èŠ±ã€ç›ã€ç™½èƒ¡æ¤’ç²‰",
                steps: "1. å¤§ç±³å†·å†»ä¸€æ™šæ›´æ˜“ç…®çƒ‚ã€‚2. ç˜¦è‚‰åˆ‡ä¸è…Œåˆ¶ã€‚3. ç±³ç…®å¼€ååŠ ä¸€åŠçš®è›‹ç…®è‡³ç²˜ç¨ ã€‚4. åŠ è‚‰ä¸å’Œå‰©ä¸‹çš®è›‹ï¼Œå‡ºé”…æ’’è‘±èŠ±ã€‚"
            },
            { name: "ç…é¥¼æœå­", meals: ["breakfast"], modes: ["delivery", "restaurant"] },
            { name: "å°ç¬¼åŒ…", meals: ["breakfast", "lunch"], modes: ["delivery", "restaurant"] },
            { 
                name: "ç‰›å¥¶éº¦ç‰‡", 
                meals: ["breakfast", "midnight"], 
                modes: ["home"], 
                ingredients: "ç‰›å¥¶ï¼ˆæˆ–ç‡•éº¦å¥¶ï¼‰ã€å³é£Ÿéº¦ç‰‡ã€åšæœç¢ã€æ°´æœä¸",
                steps: "1. éº¦ç‰‡å€’å…¥ç¢—ä¸­ã€‚2. å€’å…¥çƒ­ç‰›å¥¶/å†·ç‰›å¥¶ã€‚3. æ’’ä¸Šåšæœå’Œæ°´æœã€‚1åˆ†é’Ÿæå®šã€‚"
            },
            { name: "é¸¡è›‹çŒé¥¼", meals: ["breakfast"], modes: ["delivery", "restaurant"] },
            { 
                name: "æ¸…æ±¤é¢", 
                meals: ["breakfast", "lunch", "midnight"], 
                modes: ["home", "restaurant"], 
                ingredients: "æŒ‚é¢/ç»†é¢ã€é’èœã€ç”ŸæŠ½ã€é¦™æ²¹ã€è‘±èŠ±ã€è·åŒ…è›‹",
                steps: "1. ç¢—åº•æ”¾è‘±èŠ±ã€ç”ŸæŠ½ã€ç›ã€é¦™æ²¹ï¼Œç”¨é¢æ±¤å†²å¼€ã€‚2. ç…®é¢å’Œé’èœï¼Œæå…¥ç¢—ä¸­ã€‚3. ç…ä¸ªè·åŒ…è›‹ç›–ä¸Šå»ã€‚"
            },
            { 
                name: "åå¸ç…è›‹", 
                meals: ["breakfast"], 
                modes: ["home"], 
                ingredients: "åå¸é¢åŒ…ã€é¸¡è›‹ã€é»„æ²¹ã€ç«è…¿ç‰‡",
                steps: "1. å¹³åº•é”…é»„æ²¹èåŒ–ã€‚2. æ”¾å…¥åå¸ç…è‡³ä¸¤é¢é‡‘é»„ã€‚3. ç…è›‹å’Œç«è…¿ï¼Œå¤¹åœ¨åå¸ä¸­é—´ã€‚"
            },
            { 
                name: "è‘±æ²¹æ‹Œé¢", 
                meals: ["breakfast", "lunch", "midnight"], 
                modes: ["home", "delivery"], 
                ingredients: "æŒ‚é¢/ç»†é¢ã€å°è‘±ã€é£Ÿç”¨æ²¹ã€ç”ŸæŠ½ã€è€æŠ½ã€ç³–", 
                steps: "1. å°è‘±åˆ‡æ®µï¼Œæ²¹çƒ­ä¸‹è‘±æ®µç‚¸è‡³ç„¦é»„æå‡ºã€‚2. é”…ä¸­ç•™è‘±æ²¹ï¼ŒåŠ ç”ŸæŠ½è€æŠ½ç³–ç…®å¼€ã€‚3. ç…®é¢è¿‡å‡‰æ°´ï¼Œæ·‹ä¸Šè‘±æ²¹æ±æ‹ŒåŒ€ã€‚" 
            },
            { name: "è±†è…è„‘/è±†èŠ±", meals: ["breakfast"], modes: ["delivery", "restaurant"] },
            { name: "è‚ ç²‰", meals: ["breakfast", "lunch"], modes: ["restaurant", "delivery"] },
            { name: "èƒ¡è¾£æ±¤", meals: ["breakfast"], modes: ["restaurant", "delivery"] },
            { name: "éº¦å½“åŠ³æ—©é¤", meals: ["breakfast"], modes: ["delivery", "restaurant"] },
            { 
                name: "è’¸è›‹ç¾¹", 
                meals: ["breakfast", "lunch", "dinner"], 
                modes: ["home"], 
                ingredients: "é¸¡è›‹ 2ä¸ªã€æ¸©æ°´ã€ç”ŸæŠ½ã€é¦™æ²¹ã€è‘±èŠ±", 
                steps: "1. é¸¡è›‹æ‰“æ•£ï¼ŒåŠ å…¥1.5å€æ¸©æ°´æ…åŒ€æ’‡å»æµ®æ²«ã€‚2. ç›–ä¿é²œè†œæ‰å­”ã€‚3. æ°´å¼€è’¸8-10åˆ†é’Ÿã€‚4. æ·‹ä¸Šç”ŸæŠ½é¦™æ²¹æ’’è‘±èŠ±ã€‚" 
            },

            // --- Lunch / Dinner ---
            { 
                name: "é»„ç„–é¸¡ç±³é¥­", 
                meals: ["lunch", "dinner"], 
                modes: ["delivery", "restaurant", "home"], 
                ingredients: "é¸¡è…¿è‚‰ã€å¹²é¦™è‡ã€é’çº¢æ¤’ã€åœŸè±†ã€é»„ç„–é¸¡é…±æ–™ã€å§œè’œ",
                steps: "1. é¸¡è‚‰ç„¯æ°´ã€‚2. é”…ä¸­ç‚’é¦™å§œè’œï¼Œä¸‹é¸¡è‚‰ç¿»ç‚’ã€‚3. åŠ é…±æ–™ã€æ³¡å‘é¦™è‡å’Œæ°´ç‚–ç…®15åˆ†é’Ÿã€‚4. åŠ åœŸè±†å†ç‚–10åˆ†é’Ÿï¼Œæœ€åæ”¾é’çº¢æ¤’æ”¶æ±ã€‚"
            },
            { name: "å…°å·æ‹‰é¢", meals: ["lunch", "dinner", "midnight"], modes: ["delivery", "restaurant"] },
            { 
                name: "çº¢çƒ§ç‰›è‚‰é¢", 
                meals: ["lunch", "dinner"], 
                modes: ["delivery", "restaurant", "home"], 
                ingredients: "ç‰›è…©/ç‰›è…±å­ã€è±†ç“£é…±ã€å¤æ–™åŒ…ã€é’èœã€æ‰‹æ“€é¢",
                steps: "1. ç‰›è‚‰ç„¯æ°´ã€‚2. ç‚’é¦™è±†ç“£é…±ï¼Œä¸‹ç‰›è‚‰å’Œå¤æ–™åŒ…ï¼ŒåŠ è¶³é‡æ°´ç‚–ç…®1.5å°æ—¶ï¼ˆé«˜å‹é”…30åˆ†é’Ÿï¼‰ã€‚3. ç…®é¢ï¼Œæµ‡ä¸Šç‰›è‚‰æ±¤å¤´ã€‚"
            },
            { 
                name: "ç‚¸é…±é¢", 
                meals: ["lunch", "dinner"], 
                modes: ["home", "restaurant", "delivery"], 
                ingredients: "æ‰‹æ“€é¢ã€äº”èŠ±è‚‰ä¸ã€å¹²é»„é…±ã€ç”œé¢é…±ã€é»„ç“œä¸", 
                steps: "1. å¤šæ²¹ç…¸ç‚’äº”èŠ±è‚‰ä¸å‡ºæ²¹ã€‚2. å€’å…¥æ··åˆå¥½çš„é…±æ–™å°ç«æ…¢ç‚¸è‡³æ²¹é…±åˆ†ç¦»ã€‚3. ç…®é¢è¿‡æ°´ï¼Œç ä¸Šèœç ï¼Œæ·‹ä¸Šç‚¸é…±ã€‚" 
            },
            { name: "æ²™å¿å°åƒ", meals: ["lunch", "dinner", "midnight"], modes: ["delivery", "restaurant"] },
            { name: "éš†æ±ŸçŒªè„šé¥­", meals: ["lunch", "dinner"], modes: ["delivery", "restaurant"] },
            { 
                name: "ç›–æµ‡é¥­", 
                meals: ["lunch", "dinner"], 
                modes: ["delivery", "restaurant", "home"], 
                ingredients: "ç±³é¥­ã€è‚‰ç±»ï¼ˆé¸¡ä¸/è‚‰ä¸ï¼‰ã€æ—¶ä»¤è”¬èœã€é…±æ²¹ã€æ·€ç²‰",
                steps: "1. è‚‰ç±»è…Œåˆ¶æ»‘æ²¹ã€‚2. è”¬èœç‚’æ–­ç”Ÿã€‚3. æ··åˆç‚’åˆ¶ï¼ŒåŠ å…¥é…±æ²¹å’Œæ°´æ·€ç²‰å‹¾èŠ¡ã€‚4. æµ‡åœ¨çƒ­ç±³é¥­ä¸Šã€‚"
            },
            { 
                name: "éº»è¾£çƒ«", 
                meals: ["lunch", "dinner", "midnight"], 
                modes: ["delivery", "restaurant", "home"], 
                ingredients: "ç«é”…åº•æ–™ã€ç‰›å¥¶ã€å„ç§ä¸¸å­ã€é’èœã€å®½ç²‰ã€æ–¹ä¾¿é¢",
                steps: "1. é”…ä¸­ç‚’åŒ–ç«é”…åº•æ–™ï¼ŒåŠ æ°´å’ŒåŠè¢‹ç‰›å¥¶ï¼ˆæ±¤åº•æµ“éƒç§˜è¯€ï¼‰ã€‚2. å…ˆç…®éš¾ç†Ÿçš„ä¸¸å­å®½ç²‰ï¼Œå†ç…®é¢å’Œé’èœã€‚3. åŠ èŠéº»é…±æ›´é¦™ã€‚"
            },
            { name: "å‡‰çš®è‚‰å¤¹é¦", meals: ["lunch", "dinner"], modes: ["delivery", "restaurant"] },
            { name: "è¿‡æ¡¥ç±³çº¿", meals: ["lunch", "dinner"], modes: ["delivery", "restaurant"] },
            { name: "å†’èœ/ä¸²ä¸²é¦™", meals: ["lunch", "dinner", "midnight"], modes: ["delivery", "restaurant"] },
            { name: "é…¸è¾£ç²‰", meals: ["lunch", "dinner", "midnight"], modes: ["delivery", "restaurant"] },
            { name: "å¹²ç‚’ç‰›æ²³", meals: ["lunch", "dinner", "midnight"], modes: ["restaurant", "delivery"] },
            { name: "æµ·å—é¸¡é¥­", meals: ["lunch", "dinner"], modes: ["restaurant", "delivery"] },
            { name: "çŸ³é”…æ‹Œé¥­", meals: ["lunch", "dinner"], modes: ["restaurant", "delivery"] },
            { 
                name: "æ‰¬å·ç‚’é¥­", 
                meals: ["lunch", "dinner"], 
                modes: ["restaurant", "home"], 
                ingredients: "ç±³é¥­ã€é¸¡è›‹ã€è™¾ä»ã€ç«è…¿ã€è±Œè±†ã€èƒ¡èåœã€ç‰ç±³", 
                steps: "1. è™¾ä»ç„¯æ°´ã€‚2. é¸¡è›‹æ‰“æ•£ç‚’ç†Ÿã€‚3. ç‚’é¦™é…èœï¼Œå€’å…¥ç±³é¥­ç‚’æ•£ã€‚4. åŠ ç›è°ƒå‘³ï¼Œé¢—ç²’åˆ†æ˜å³å¯ã€‚" 
            },
            { 
                name: "è½»é£Ÿæ²™æ‹‰", 
                meals: ["lunch", "dinner"], 
                modes: ["delivery", "home"], 
                ingredients: "ç”Ÿèœ/è‹¦èŠã€é¸¡èƒ¸è‚‰/è™¾ä»ã€åœ£å¥³æœã€é»„ç“œã€æ²¹é†‹æ±/åƒå²›é…±", 
                steps: "1. è”¬èœæ´—å‡€æ²¥å¹²ã€‚2. è›‹ç™½è´¨ç±»ç…®ç†Ÿåˆ‡å—ã€‚3. æ··åˆæ‰€æœ‰é£Ÿæï¼Œæ·‹ä¸Šé…±æ±æ‹ŒåŒ€ã€‚" 
            },

            // --- Feasts ---
            { name: "é‡åº†ç«é”…", meals: ["lunch", "dinner"], modes: ["restaurant"] },
            { name: "éŸ©å¼çƒ¤è‚‰", meals: ["lunch", "dinner"], modes: ["restaurant"] },
            { name: "æ—¥å¼å¯¿å¸", meals: ["lunch", "dinner"], modes: ["delivery", "restaurant"] },
            { 
                name: "æŠ«è¨", 
                meals: ["lunch", "dinner", "midnight"], 
                modes: ["delivery", "restaurant", "home"], 
                ingredients: "ç°æˆæŠ«è¨é¥¼åº•ã€é©¬è‹é‡Œæ‹‰èŠå£«ç¢ã€ç•ªèŒ„é…±ã€åŸ¹æ ¹ã€é’æ¤’",
                steps: "1. é¥¼åº•åˆ·ç•ªèŒ„é…±ã€‚2. é“ºä¸€å±‚èŠå£«ï¼Œæ”¾ä¸ŠåŸ¹æ ¹é’æ¤’ç­‰æ–™ã€‚3. å†é“ºä¸€å±‚åšåšèŠå£«ã€‚4. çƒ¤ç®±200åº¦çƒ¤15åˆ†é’Ÿã€‚"
            },
            { name: "æ±‰å ¡ç‚¸é¸¡", meals: ["lunch", "dinner", "midnight"], modes: ["delivery", "restaurant"] },
            { 
                name: "é…¸èœé±¼", 
                meals: ["lunch", "dinner"], 
                modes: ["delivery", "restaurant", "home"], 
                ingredients: "è‰é±¼/å·´æ²™é±¼ç‰‡ã€é…¸èœé±¼è°ƒæ–™åŒ…ã€è±†èŠ½ã€åƒå¼ ",
                steps: "1. é±¼ç‰‡ç”¨è›‹æ¸…æ·€ç²‰è…Œåˆ¶ã€‚2. ç‚’é¦™é…¸èœï¼ŒåŠ æ°´ç…®æ²¸ã€‚3. ä¸‹é…èœç…®ç†Ÿæå‡ºé“ºç¢—åº•ã€‚4. å…³å°ç«ä¸€ç‰‡ç‰‡ä¸‹é±¼ç‰‡ï¼Œå˜è‰²å³å‡ºé”…ã€‚5. æµ‡çƒ­æ²¹æ¿€é¦™èŠ±æ¤’ã€‚"
            },
            { 
                name: "ç‰›æ’", 
                meals: ["lunch", "dinner"], 
                modes: ["restaurant", "home"], 
                ingredients: "åŸåˆ‡ç‰›æ’ã€é»„æ²¹ã€è¿·è¿­é¦™ã€é»‘èƒ¡æ¤’æµ·ç›ã€å¤§è’œ",
                steps: "1. ç‰›æ’è§£å†»å¸å¹²æ°´ï¼Œæ’’æµ·ç›é»‘èƒ¡æ¤’ã€‚2. é”…çƒ§çƒ­ï¼Œå¤§ç«æ¯é¢ç…1-2åˆ†é’Ÿï¼ˆè§†åšåº¦ï¼‰ã€‚3. å…³ç«æ”¾å…¥é»„æ²¹å¤§è’œè¿·è¿­é¦™æ·‹æ²¹å¢é¦™ã€‚4. é™ç½®5åˆ†é’Ÿå†åˆ‡ã€‚"
            },
            { name: "çƒ¤é±¼", meals: ["lunch", "dinner"], modes: ["restaurant", "delivery"] },
            { name: "æ—¥å¼æ‹‰é¢", meals: ["lunch", "dinner"], modes: ["restaurant"] },
            { name: "ç²¤å¼æ—©èŒ¶/ç‚¹å¿ƒ", meals: ["breakfast", "lunch"], modes: ["restaurant"] },
            { name: "åŒ—äº¬çƒ¤é¸­", meals: ["lunch", "dinner"], modes: ["restaurant"] },

            // --- Home Cooking ---
            { 
                name: "ç•ªèŒ„ç‚’è›‹é…ç±³é¥­", 
                meals: ["lunch", "dinner"], 
                modes: ["home"], 
                ingredients: "é¸¡è›‹ 3ä¸ªã€ç•ªèŒ„ 2ä¸ªã€è‘±èŠ±ã€æ²¹ã€ç›ã€ç³–ã€å¤§ç±³",
                steps: "1. é¸¡è›‹ç‚’ç†Ÿç››å‡ºã€‚2. ç•ªèŒ„ç‚’å‡ºæ±ï¼ˆå¯åŠ ç‚¹ç•ªèŒ„é…±ï¼‰ã€‚3. å€’å…¥é¸¡è›‹ï¼ŒåŠ ç›å’Œä¸€ç‚¹ç³–æé²œã€‚4. æ’’è‘±èŠ±å‡ºé”…ï¼Œæ‹Œé¥­ç¥å™¨ï¼"
            },
            { 
                name: "åœŸè±†çƒ§ç‰›è‚‰", 
                meals: ["lunch", "dinner"], 
                modes: ["home", "restaurant", "delivery"], 
                ingredients: "ç‰›è…©ã€åœŸè±†ã€èƒ¡èåœã€æ´‹è‘±ã€å…«è§’ã€æ¡‚çš®ã€ç”ŸæŠ½ã€è€æŠ½ã€å†°ç³–", 
                steps: "1. ç‰›è‚‰ç„¯æ°´ã€‚2. ç‚’ç³–è‰²æˆ–ç›´æ¥ç‚’é¦™ç‰›è‚‰ï¼ŒåŠ é¦™æ–™ã€‚3. åŠ æ°´ç‚–ç…®1å°æ—¶ã€‚4. åŠ å…¥åœŸè±†èƒ¡èåœå—å†ç‚–20åˆ†é’Ÿæ”¶æ±ã€‚" 
            },
            { 
                name: "å®«ä¿é¸¡ä¸", 
                meals: ["lunch", "dinner"], 
                modes: ["home", "restaurant", "delivery"], 
                ingredients: "é¸¡èƒ¸è‚‰ã€èŠ±ç”Ÿç±³ã€å¹²è¾£æ¤’ã€èŠ±æ¤’ã€è‘±æ®µã€ç³–ã€é†‹ã€æ·€ç²‰", 
                steps: "1. é¸¡ä¸è…Œåˆ¶æ»‘ç†Ÿç››å‡ºã€‚2. è°ƒå®«ä¿æ±ï¼ˆç³–é†‹ç”ŸæŠ½æ·€ç²‰æ°´ï¼‰ã€‚3. çˆ†é¦™è¾£æ¤’èŠ±æ¤’ï¼Œä¸‹é¸¡ä¸å’ŒèŠ±ç”Ÿã€‚4. æ·‹å…¥æ–™æ±å¤§ç«ç¿»ç‚’æ”¶æ±ã€‚" 
            },
            { 
                name: "éº»å©†è±†è…", 
                meals: ["lunch", "dinner"], 
                modes: ["home", "restaurant", "delivery"], 
                ingredients: "å«©è±†è…ã€ç‰›è‚‰æœ«/çŒªè‚‰æœ«ã€è±†ç“£é…±ã€èŠ±æ¤’ç²‰ã€è’œè‹—ã€æ°´æ·€ç²‰", 
                steps: "1. è±†è…åˆ‡å—ç„¯ç›æ°´ã€‚2. ç‚’é…¥è‚‰æœ«ï¼ŒåŠ è±†ç“£é…±ç‚’å‡ºçº¢æ²¹ã€‚3. åŠ æ°´ç…®è±†è…3åˆ†é’Ÿã€‚4. åˆ†ä¸‰æ¬¡å‹¾èŠ¡ï¼Œå‡ºé”…æ’’åšåšèŠ±æ¤’ç²‰ã€‚" 
            },
            { 
                name: "å›é”…è‚‰", 
                meals: ["lunch", "dinner"], 
                modes: ["restaurant", "home"], 
                ingredients: "äº”èŠ±è‚‰ï¼ˆäºŒåˆ€è‚‰ï¼‰ã€é’è’œè‹—ã€è±†è±‰ã€éƒ«å¿è±†ç“£é…±ã€ç”œé¢é…±", 
                steps: "1. äº”èŠ±è‚‰å†·æ°´ç…®è‡³å…«åˆ†ç†Ÿåˆ‡ç‰‡ã€‚2. é”…ä¸­ç…¸ç‚’è‚‰ç‰‡å‡ºæ²¹ï¼ˆç¯ç›çªï¼‰ã€‚3. åŠ è±†ç“£é…±ç”œé¢é…±ç‚’å‡ºçº¢æ²¹ã€‚4. ä¸‹è’œè‹—æ®µæ–­ç”Ÿå‡ºé”…ã€‚" 
            },
            { 
                name: "ç…®æ³¡é¢åŠ è‚ ", 
                meals: ["lunch", "dinner", "midnight"], 
                modes: ["home"], 
                ingredients: "æ–¹ä¾¿é¢ä¸€åŒ…ã€ç«è…¿è‚ ã€é¸¡è›‹ã€é’èœ",
                steps: "1. æ°´å¼€ç…®é¢é¥¼ã€‚2. é¢æ•£å¼€åæ‰“å…¥é¸¡è›‹ï¼ˆä¸è¦æ…åŠ¨ï¼‰ã€‚3. åŠ è°ƒæ–™åŒ…ã€ç«è…¿è‚ ã€é’èœã€‚4. ç…®è‡³å–œæ¬¢çš„è½¯ç¡¬åº¦ã€‚"
            },
            { 
                name: "é€Ÿå†»æ°´é¥º", 
                meals: ["lunch", "dinner", "midnight"], 
                modes: ["home"], 
                ingredients: "é€Ÿå†»é¥ºå­ï¼ˆéŸ­èœ/ç‰ç±³/ç™½èœï¼‰ã€é™ˆé†‹ã€è¾£æ¤’æ²¹",
                steps: "1. æ°´å¼€ä¸‹é¥ºå­ï¼Œç”¨å‹ºèƒŒè½»æ¨é˜²ç²˜åº•ã€‚2. æ°´å¼€åç‚¹ä¸‰æ¬¡å†·æ°´ï¼ˆâ€œä¸‰ç‚¹æ°´â€ï¼‰ã€‚3. é¥ºå­å…¨éƒ¨æµ®èµ·ä¸”è‚šå­é¼“èƒ€å³å¯ã€‚"
            },
            { 
                name: "æ¸…ç‚’æ—¶è”¬", 
                meals: ["lunch", "dinner"], 
                modes: ["home"], 
                ingredients: "å½“å­£é’èœï¼ˆæ²¹èœ/è èœ/ç”Ÿèœï¼‰ã€è’œæœ«ã€èšæ²¹ã€ç›",
                steps: "1. é”…çƒ­å€’æ²¹ï¼Œçˆ†é¦™è’œæœ«ã€‚2. ä¸‹é’èœå¤§ç«å¿«ç‚’ï¼ˆé˜²æ­¢å‡ºæ°´ï¼‰ã€‚3. å˜è½¯ååŠ ç›ã€èšæ²¹è°ƒå‘³ï¼Œè¿…é€Ÿå‡ºé”…ã€‚"
            },
            { 
                name: "å¯ä¹é¸¡ç¿…", 
                meals: ["lunch", "dinner"], 
                modes: ["home"], 
                ingredients: "é¸¡ä¸­ç¿… 8-10ä¸ªã€å¯ä¹ä¸€ç“¶ã€å§œç‰‡ã€æ–™é…’ã€ç”ŸæŠ½",
                steps: "1. é¸¡ç¿…ä¸¤é¢æ”¹åˆ€ï¼Œå†·æ°´ç„¯æ°´ã€‚2. ç…è‡³ä¸¤é¢é‡‘é»„ã€‚3. å€’å…¥å¯ä¹æ²¡è¿‡é¸¡ç¿…ï¼ŒåŠ å§œç‰‡é…±æ²¹ã€‚4. ä¸­ç«ç…®15åˆ†é’Ÿï¼Œå¤§ç«æ”¶æ±è‡³ç²˜ç¨ ã€‚"
            },
            { 
                name: "å’–å–±é¥­", 
                meals: ["lunch", "dinner"], 
                modes: ["home"], 
                ingredients: "å’–å–±å—ã€é¸¡èƒ¸è‚‰/ç‰›è‚‰ã€åœŸè±†ã€èƒ¡èåœã€æ´‹è‘±ã€ç±³é¥­",
                steps: "1. é£Ÿæåˆ‡ä¸ï¼Œæ´‹è‘±çˆ†é¦™ã€‚2. ä¸‹è‚‰å’Œè”¬èœç¿»ç‚’ã€‚3. åŠ æ°´æ²¡è¿‡é£Ÿæç…®ç†ŸåœŸè±†ã€‚4. å…³ç«æ”¾å…¥å’–å–±å—æ…æ‹ŒèåŒ–ã€‚5. å¼€å¾®ç«ç‚–ç…®è‡³æµ“ç¨ ã€‚"
            },
            { 
                name: "è›‹ç‚’é¥­", 
                meals: ["lunch", "dinner", "midnight"], 
                modes: ["home"], 
                ingredients: "éš”å¤œç±³é¥­ã€é¸¡è›‹ã€ç«è…¿ä¸ã€è‘±èŠ±ã€æ‚èœç²’",
                steps: "1. é”…çƒ­æ²¹ï¼Œå…ˆæ»‘ç‚’é¸¡è›‹ç››å‡ºã€‚2. ç‚’é¦™ç«è…¿æ‚èœã€‚3. å€’å…¥ç±³é¥­ç‚’æ•£ã€‚4. å€’å…¥é¸¡è›‹ï¼ŒåŠ ç›/ç”ŸæŠ½ï¼Œå¤§ç«ç¿»ç‚’å‡åŒ€ã€‚"
            },
            { 
                name: "çº¢çƒ§è‚‰", 
                meals: ["lunch", "dinner"], 
                modes: ["home"], 
                ingredients: "äº”èŠ±è‚‰ã€å†°ç³–ã€ç”ŸæŠ½ã€è€æŠ½ã€å§œç‰‡ã€å…«è§’",
                steps: "1. äº”èŠ±è‚‰åˆ‡å—ç„¯æ°´ã€‚2. é”…ä¸­å°‘æ²¹ç‚’åŒ–å†°ç³–ï¼ˆç³–è‰²ï¼‰ã€‚3. ä¸‹è‚‰ç¿»ç‚’ä¸Šè‰²ï¼ŒåŠ é¦™æ–™é…±æ²¹ã€‚4. åŠ å¼€æ°´æ²¡è¿‡è‚‰ï¼Œå°ç«æ…¢ç‚–1å°æ—¶ï¼Œå¤§ç«æ”¶æ±ã€‚"
            },
            { 
                name: "æ‹é»„ç“œé…ç²¥", 
                meals: ["dinner", "midnight"], 
                modes: ["home"], 
                ingredients: "é»„ç“œã€å¤§è’œã€è¾£æ¤’æ²¹ã€é™ˆé†‹ã€ç™½ç³–ã€å¤§ç±³",
                steps: "1. é»„ç“œç”¨åˆ€èƒŒæ‹ç¢åˆ‡æ®µã€‚2. åŠ è’œæœ«ã€ç›ã€ç³–ã€é†‹ã€è¾£æ¤’æ²¹æ‹ŒåŒ€ã€‚3. è…Œåˆ¶10åˆ†é’Ÿæ›´å…¥å‘³ï¼Œé…ç™½ç²¥ç»ä½³ã€‚"
            },
            { 
                name: "ç…é¥º", 
                meals: ["lunch", "dinner", "midnight"], 
                modes: ["home"], 
                ingredients: "é€Ÿå†»é¥ºå­ã€é£Ÿç”¨æ²¹ã€æ°´ã€é»‘èŠéº»",
                steps: "1. å¹³åº•é”…åˆ·æ²¹æ‘†å¥½é¥ºå­ï¼Œç…åˆ°åº•éƒ¨é‡‘é»„ã€‚2. å€’å…¥æ²¡è¿‡é¥ºå­åº•éƒ¨çš„é¢ç²‰æ°´/æ¸…æ°´ã€‚3. ç›–ç›–ç„–å¹²æ°´åˆ†ã€‚4. æ’’èŠéº»è‘±èŠ±å‡ºé”…ã€‚"
            },
            
            // --- Midnight Snacks ---
            { 
                name: "çƒ¤å†·é¢", 
                meals: ["dinner", "midnight"], 
                modes: ["delivery", "home"], 
                ingredients: "å†·é¢ç‰‡ã€é¸¡è›‹ã€ç«è…¿è‚ ã€æ´‹è‘±ç¢ã€é¦™èœã€è’œè“‰è¾£é…±ã€é†‹ã€ç³–", 
                steps: "1. å¹³åº•é”…åˆ·æ²¹ç…å†·é¢ç‰‡ã€‚2. æ‰“ä¸ªé¸¡è›‹æ‘Šå¹³ã€‚3. ç¿»é¢åˆ·é…±ï¼Œæ”¾ç«è…¿æ´‹è‘±ã€‚4. å·èµ·åˆ‡å—ï¼Œæ’’é¦™èœã€‚" 
            },
            { name: "çƒ§çƒ¤/æ’¸ä¸²", meals: ["dinner", "midnight"], modes: ["delivery", "restaurant"] },
            { name: "ç‚¸é¸¡å•¤é…’", meals: ["dinner", "midnight"], modes: ["delivery", "restaurant"] },
            { name: "å°é¾™è™¾", meals: ["dinner", "midnight"], modes: ["delivery", "restaurant"] },
            { 
                name: "èºè›³ç²‰", 
                meals: ["lunch", "dinner", "midnight"], 
                modes: ["delivery", "home"], 
                ingredients: "èºè›³ç²‰åŒ…ã€ç©ºå¿ƒèœï¼ˆæ¨èï¼‰ã€ç‚¸è›‹ï¼ˆæ¨èï¼‰",
                steps: "1. å¹²ç²‰å†·æ°´ä¸‹é”…ç…®10åˆ†é’Ÿæå‡ºã€‚2. å¦èµ·é”…çƒ§æ°´ï¼ŒåŠ æ±¤åº•åŒ…å’Œç…®å¥½çš„ç²‰ã€‚3. åŠ é…èœåŒ…ï¼ˆè…ç«¹èŠ±ç”Ÿé…¸ç¬‹ç­‰ï¼‰ã€‚4. å…³ç«åŠ è¾£æ²¹å’Œé†‹ã€‚"
            },
        ];

        // --- State ---
        let currentMeal = 'lunch';
        let currentMode = 'delivery';
        let isSpinning = false;
        let animationInterval = null;
        let lastResult = null;
        
        // **New State Object** to store results per mode
        let currentMealState = {
            delivery: null,
            restaurant: null,
            home: null
        };

        // --- Functions ---

        function setMeal(meal) {
            if(isSpinning) return;
            currentMeal = meal;
            
            // Clear history when changing meal time
            currentMealState = { delivery: null, restaurant: null, home: null };
            
            updateButtons('btn-breakfast', 'btn-lunch', 'btn-dinner', 'btn-midnight', `btn-${meal}`);
            resetDisplay();
            lastResult = null;
        }

        function setMode(mode) {
            if(isSpinning) return;
            currentMode = mode;
            updateButtons('btn-delivery', 'btn-restaurant', 'btn-home', null, `btn-${mode}`);
            
            // Check if we have a saved result for this mode
            if (currentMealState[mode]) {
                // Restore previous result without animation
                renderFoodResult(currentMealState[mode], false);
            } else {
                resetDisplay();
            }
        }

        function updateButtons(id1, id2, id3, id4, activeId) {
            const ids = [id1, id2, id3, id4].filter(id => id !== null);
            ids.forEach(id => {
                const btn = document.getElementById(id);
                if (id === activeId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function resetDisplay() {
            document.getElementById('food-display').innerText = "ç­‰å¾…é€‰æ‹©...";
            document.getElementById('food-display').classList.remove('text-orange-600');
            document.getElementById('food-display').classList.add('text-gray-700');
            document.getElementById('placeholder-icon').innerHTML = '<i class="fas fa-question-circle text-4xl"></i>';
            document.getElementById('result-container').classList.remove('border-orange-500', 'bg-orange-50');
            document.getElementById('result-container').classList.add('border-gray-300', 'bg-gray-50');
            document.getElementById('food-desc').classList.add('hidden');
            document.getElementById('recipe-container').classList.add('hidden');
            document.getElementById('restaurant-container').classList.add('hidden');
            
            // Reset button to initial state
            const btn = document.getElementById('action-btn');
            btn.innerHTML = '<i class="fas fa-dice"></i> å¸®æˆ‘å†³å®šï¼';
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }

        function getFilteredFood() {
            return foodDatabase.filter(item => {
                return item.meals.includes(currentMeal) && item.modes.includes(currentMode);
            });
        }

        function startRandomize() {
            if (isSpinning) return;

            const candidates = getFilteredFood();
            
            if (candidates.length === 0) {
                alert("è¿™ä¸ªç»„åˆä¸‹æš‚æ—¶æ²¡æœ‰åˆé€‚çš„é£Ÿç‰©æ¨èï¼Œæ¢ä¸ªè¯•è¯•ï¼Ÿ\n(ä¾‹å¦‚ï¼šæ—©é¤å¾ˆå°‘åƒç«é”…...)");
                return;
            }

            isSpinning = true;
            resetDisplay();
            
            const display = document.getElementById('food-display');
            const btn = document.getElementById('action-btn');
            const container = document.getElementById('result-container');
            const icon = document.getElementById('placeholder-icon');
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ€è€ƒ...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            container.classList.remove('bg-gray-50', 'border-gray-300');
            container.classList.add('bg-white', 'border-orange-300');
            icon.innerHTML = '<i class="fas fa-utensils text-4xl animate-bounce text-orange-400"></i>';

            let counter = 0;
            const totalSpins = 25; 
            
            clearInterval(animationInterval);
            
            animationInterval = setInterval(() => {
                const randomTemp = candidates[Math.floor(Math.random() * candidates.length)];
                display.innerText = randomTemp.name;
                counter++;

                if (counter >= totalSpins) {
                    finishSpin(candidates);
                }
            }, 80);
        }

        function finishSpin(candidates) {
            clearInterval(animationInterval);
            
            let finalPool = candidates;
            if (candidates.length > 1 && lastResult) {
                finalPool = candidates.filter(item => item.name !== lastResult);
            }

            const finalChoice = finalPool[Math.floor(Math.random() * finalPool.length)];
            lastResult = finalChoice.name;
            
            // Save state for the current mode
            currentMealState[currentMode] = finalChoice;

            renderFoodResult(finalChoice, true);
        }

        // New function to handle UI rendering
        function renderFoodResult(foodItem, withAnimation) {
            const display = document.getElementById('food-display');
            const btn = document.getElementById('action-btn');
            const container = document.getElementById('result-container');
            const icon = document.getElementById('placeholder-icon');
            const desc = document.getElementById('food-desc');
            const recipeContainer = document.getElementById('recipe-container');
            const restaurantContainer = document.getElementById('restaurant-container');
            const recipeIng = document.getElementById('recipe-ingredients');
            const recipeSteps = document.getElementById('recipe-steps');
            const searchLink = document.getElementById('search-link');

            // Result UI
            display.innerText = foodItem.name;
            display.classList.remove('text-gray-700');
            display.classList.add('text-orange-600');
            
            container.classList.remove('border-orange-300', 'border-dashed');
            container.classList.add('border-orange-500', 'border-solid', 'bg-orange-50');
            
            if (withAnimation) {
                container.classList.add('shake');
            }
            
            // Icon Logic
            let iconClass = 'fa-utensils';
            if(currentMeal === 'breakfast') iconClass = 'fa-coffee';
            if(currentMeal === 'midnight') iconClass = 'fa-moon';
            if(currentMode === 'delivery') iconClass = 'fa-motorcycle';
            if(currentMode === 'home') iconClass = 'fa-utensil-spoon';
            
            icon.innerHTML = `<i class="fas ${iconClass} text-5xl text-orange-500"></i>`;
            
            desc.innerText = `å®Œç¾ï¼${getModeName()}åƒ${foodItem.name}ï¼`;
            desc.classList.remove('hidden');

            // --- Mode Logic ---
            // 1. Home Mode: Show Recipe
            if (currentMode === 'home' && foodItem.ingredients) {
                recipeIng.innerText = foodItem.ingredients;
                if (foodItem.steps) {
                    recipeSteps.innerText = foodItem.steps;
                } else {
                    recipeSteps.innerText = "æš‚æ— è¯¦ç»†æ­¥éª¤ï¼Œè¯·å‘æŒ¥ä½ çš„å¨è‰ºå¤©èµ‹ï¼";
                }
                searchLink.href = `https://www.douyin.com/search/${encodeURIComponent(foodItem.name + "åšæ³•")}`;
                recipeContainer.classList.remove('hidden');
                restaurantContainer.classList.add('hidden');
            } 
            // 2. Restaurant Mode: Show Nearby Search
            else if (currentMode === 'restaurant') {
                document.getElementById('restaurant-food-name').innerText = foodItem.name;
                // Update global var for search
                window.currentSearchName = foodItem.name;
                
                recipeContainer.classList.add('hidden');
                restaurantContainer.classList.remove('hidden');
            }
            // 3. Delivery/Other
            else {
                recipeContainer.classList.add('hidden');
                restaurantContainer.classList.add('hidden');
            }

            btn.innerHTML = '<i class="fas fa-redo"></i> ä¸æ»¡æ„ï¼Ÿæ¢ä¸€ä¸ª';
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
            
            isSpinning = false;
            
            if (withAnimation) {
                setTimeout(() => {
                    container.classList.remove('shake');
                }, 500);
                fireConfetti();
            }
        }

        // --- Nearby Search Logic ---
        function searchNearby(platform) {
            // Need to get the name from the stored state or the current display logic
            // Since we store state in currentMealState[currentMode], we can use that,
            // or simply rely on the text content if the user hasn't switched mode yet.
            // But better to use the specific food item for the current mode.
            
            let query = "";
            if (currentMealState['restaurant']) {
                query = currentMealState['restaurant'].name;
            } else if (window.currentSearchName) {
                query = window.currentSearchName;
            }
            
            if (!query) return;

            if (platform === 'meituan') {
                window.open(`https://i.meituan.com/s/${encodeURIComponent(query)}`, '_blank');
            } 
            else if (platform === 'amap') {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            window.open(`https://uri.amap.com/search?keyword=${encodeURIComponent(query)}&mode=list&center=${lon},${lat}`, '_blank');
                        },
                        (error) => {
                            window.open(`https://uri.amap.com/search?keyword=${encodeURIComponent(query)}`, '_blank');
                        }
                    );
                } else {
                    window.open(`https://uri.amap.com/search?keyword=${encodeURIComponent(query)}`, '_blank');
                }
            }
        }

        function getModeName() {
            if(currentMode === 'home') return 'åœ¨å®¶';
            if(currentMode === 'delivery') return 'ç‚¹å¤–å–';
            if(currentMode === 'restaurant') return 'å‡ºå»';
            return '';
        }

        function fireConfetti() {
            const colors = ['#f59e0b', '#ef4444', '#10b981', '#3b82f6'];
            const container = document.getElementById('confetti-container');
            container.classList.remove('hidden');
            container.innerHTML = '';

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
                confetti.style.opacity = Math.random();
                container.appendChild(confetti);
            }

            setTimeout(() => {
                container.classList.add('hidden');
                container.innerHTML = '';
            }, 3000);
        }

        resetDisplay();
    </script>
</body>
</html>
